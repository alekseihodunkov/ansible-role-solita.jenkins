#!/usr/bin/python
SCRIPT="""
import groovy.json.*
import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.impl.*

jsonSlurper = new JsonSlurper()
def params = jsonSlurper.parseText('%s')

result = [ changed: false ]

def jenkins = Jenkins.getInstance()
def creds = CredentialsProvider.lookupCredentials(
    common.StandardUsernameCredentials.class, jenkins)

def addPassword = { id, username, password, description ->

    def c = creds.findResult { it.id == id ? it : null }

    if ( c ) {
        result.changed = false
    } else {
        def cred_store = jenkins.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()
        def addresult = cred_store.addCredentials(
            domains.Domain.global(),
            new UsernamePasswordCredentialsImpl(
                CredentialsScope.GLOBAL, id,
                description, username, password))

        if (addresult) {
            result.changed = true
        } else {
            throw new RuntimeException('Failed to create credentials')
        }
    }
}

addPassword(params.id, params.name, params.password, params.description)
jenkins.save()

println JsonOutput.toJson(result)
"""

import json

def main():
    module = AnsibleModule(
        argument_spec = dict(
            solita_jenkins_cli=dict(type='str', required=True),
            id=dict(type='str', required=True),
            name=dict(type='str', required=True),
            password=dict(type='str'),
            description=dict(type='str')
        )
    )

    script_args_json = json.dumps(
            dict(id=module.params.get('id'),
                name=module.params.get('name'),
                password=module.params.get('password'),
                description=module.params.get('description')))

    rc, stdout, stderr = module.run_command(
            "%(solita_jenkins_cli)s groovy =" % module.params,
            data=(SCRIPT % script_args_json))

    if (rc != 0):
        module.fail_json(msg=stderr)

    print stdout

from ansible.module_utils.basic import *
if __name__ == '__main__':
    main()

